name: Build and Deploy Demo App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write    
  packages: write    

env:
  IMAGE_REPO: ghcr.io/arthur-16/argodemo
  CHART_PATH: .
  VALUES_DEV_FILE: ./values-dev.yaml
  VALUES_STAGING_FILE: ./values-staging.yaml

concurrency:
  group: build-and-pin-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      digest: ${{ steps.build.outputs.digest }}
      short-sha: ${{ steps.meta.outputs.short-sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Need full history for proper git operations
          fetch-depth: 0

      # Enable emulation so we can build arm64 on x86 runners
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Derive tags and metadata
        id: meta
        run: |
          SHORT_SHA="$(git rev-parse --short=12 HEAD)"
          TIMESTAMP="$(date +%Y%m%d%H%M%S)"
          echo "short-sha=${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "timestamp=${TIMESTAMP}" >> "$GITHUB_OUTPUT"
          echo "tags=${{ env.IMAGE_REPO }}:${SHORT_SHA},${{ env.IMAGE_REPO }}:dev,${{ env.IMAGE_REPO }}:latest" >> "$GITHUB_OUTPUT"

      - name: Build & push multi-arch image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./app/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: |
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ steps.meta.outputs.timestamp }}

      - name: Show build results
        run: |
          echo "üöÄ Build completed successfully!"
          echo "Image: ${{ env.IMAGE_REPO }}"
          echo "Digest: ${{ steps.build.outputs.digest }}"
          echo "Short SHA: ${{ steps.meta.outputs.short-sha }}"

  update-dev:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Use a PAT or github token with write permissions
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install yq
        uses: mikefarah/yq@v4.44.3

      - name: Pin digest in dev values
        env:
          IMAGE_REPO: ${{ env.IMAGE_REPO }}
          DIGEST: ${{ needs.build.outputs.digest }}
          SHORT_SHA: ${{ needs.build.outputs.short-sha }}
        run: |
          echo "üîí Pinning image digest in development environment"
          echo "Repository: $IMAGE_REPO"
          echo "Digest: $DIGEST"
          echo "Short SHA: $SHORT_SHA"
          
          # Verify the values file exists
          if [[ ! -f "${{ env.VALUES_DEV_FILE }}" ]]; then
            echo "‚ùå Values file not found: ${{ env.VALUES_DEV_FILE }}"
            echo "Available files in root directory:"
            ls -la demo/ || echo "Demo directory not found"
            exit 1
          fi
          
          # Update the image configuration
          yq -i '.image.repository = strenv(IMAGE_REPO)' "${{ env.VALUES_DEV_FILE }}"
          yq -i '.image.digest = strenv(DIGEST)' "${{ env.VALUES_DEV_FILE }}"
          
          # Update demo version to include SHA for visual confirmation
          yq -i '.demo.version = "dev-v1.1-" + strenv(SHORT_SHA)' "${{ env.VALUES_DEV_FILE }}"
          yq -i '.demo.message = "GitOps Demo - Development (' + strenv(SHORT_SHA) + ') üöÄ"' "${{ env.VALUES_DEV_FILE }}"
          
          echo "‚úÖ Updated values file:"
          echo "--- ${{ env.VALUES_DEV_FILE }} ---"
          cat "${{ env.VALUES_DEV_FILE }}"

      - name: Commit and push changes
        env:
          DIGEST: ${{ needs.build.outputs.digest }}
          SHORT_SHA: ${{ needs.build.outputs.short-sha }}
        run: |
          git config user.name "ci-bot"
          git config user.email "ci@arthur-16.github.io"
          
          # Check if there are changes to commit
          if git diff --quiet "${{ env.VALUES_DEV_FILE }}"; then
            echo "‚ÑπÔ∏è No changes to commit"
            exit 0
          fi
          
          git add "${{ env.VALUES_DEV_FILE }}"
          git commit -m "üîí Pin dev image to ${SHORT_SHA}

          Digest: ${DIGEST}
          
          This commit was automatically generated by CI to pin the
          development environment to an immutable image digest."
          
          # Push with retry logic
          for i in {1..3}; do
            if git push origin main; then
              echo "‚úÖ Successfully pushed changes"
              break
            else
              echo "‚ö†Ô∏è Push failed, attempt $i/3"
              if [[ $i -eq 3 ]]; then
                echo "‚ùå Failed to push after 3 attempts"
                exit 1
              fi
              sleep 2
              git pull --rebase origin main
            fi
          done

  promote-to-staging:
    needs: [build, update-dev]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    # Add manual approval for staging promotions
    environment: staging
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install yq
        uses: mikefarah/yq@v4.44.3

      - name: Promote to staging
        env:
          IMAGE_REPO: ${{ env.IMAGE_REPO }}
          DIGEST: ${{ needs.build.outputs.digest }}
          SHORT_SHA: ${{ needs.build.outputs.short-sha }}
        run: |
          echo "üéØ Promoting to staging environment"
          
          # Pull latest changes from dev update
          git pull origin main
          
          # Verify staging values file exists
          if [[ ! -f "${{ env.VALUES_STAGING_FILE }}" ]]; then
            echo "‚ùå Staging values file not found: ${{ env.VALUES_STAGING_FILE }}"
            exit 1
          fi
          
          # Update staging with the same digest as dev
          yq -i '.image.repository = strenv(IMAGE_REPO)' "${{ env.VALUES_STAGING_FILE }}"
          yq -i '.image.digest = strenv(DIGEST)' "${{ env.VALUES_STAGING_FILE }}"
          
          # Update staging version info
          yq -i '.demo.version = "staging-v1.1-" + strenv(SHORT_SHA)' "${{ env.VALUES_STAGING_FILE }}"
          yq -i '.demo.message = "GitOps Demo - Staging (' + strenv(SHORT_SHA) + ') üéØ"' "${{ env.VALUES_STAGING_FILE }}"
          
          echo "‚úÖ Updated staging values file:"
          echo "--- ${{ env.VALUES_STAGING_FILE }} ---"
          cat "${{ env.VALUES_STAGING_FILE }}"

      - name: Commit staging promotion
        env:
          DIGEST: ${{ needs.build.outputs.digest }}
          SHORT_SHA: ${{ needs.build.outputs.short-sha }}
        run: |
          git config user.name "ci-bot"
          git config user.email "ci@arthur-16.github.io"
          
          if git diff --quiet "${{ env.VALUES_STAGING_FILE }}"; then
            echo "‚ÑπÔ∏è No staging changes to commit"
            exit 0
          fi
          
          git add "${{ env.VALUES_STAGING_FILE }}"
          git commit -m "üéØ Promote ${SHORT_SHA} to staging

          Digest: ${DIGEST}
          
          Promoting the same immutable image digest from development
          to staging environment after successful testing."
          
          git push origin main

  # Optional: Slack/Teams notification
  notify:
    needs: [build, update-dev, promote-to-staging]
    runs-on: ubuntu-latest
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - name: Notification
        env:
          BUILD_STATUS: ${{ needs.build.result }}
          DEV_STATUS: ${{ needs.update-dev.result }}
          STAGING_STATUS: ${{ needs.promote-to-staging.result }}
          DIGEST: ${{ needs.build.outputs.digest }}
          SHORT_SHA: ${{ needs.build.outputs.short-sha }}
        run: |
          echo "üìä Pipeline Results:"
          echo "  üî® Build: $BUILD_STATUS"
          echo "  üöÄ Dev Update: $DEV_STATUS"
          echo "  üéØ Staging Promotion: $STAGING_STATUS"
          echo "  üì¶ Image: ${{ env.IMAGE_REPO }}@$DIGEST"
          echo "  üè∑Ô∏è SHA: $SHORT_SHA"
          
          # Add your notification logic here (Slack, Teams, email, etc.)
          # Example for webhook notifications:
          # curl -X POST "your-webhook-url" -d "Deploy completed: $SHORT_SHA"

